# =============================================================================
# Sugarclass - Unified Docker Compose
# =============================================================================
# This file orchestrates:
#   1. Main Dashboard (Shell) - Frontend & Backend
#   2. AI Writer Microservice - News-based writing platform
#   3. AI Tutor Microservice - RAG-based tutoring (Planned for future)
# =============================================================================

services:
  # ===========================================================================
  # MAIN DASHBOARD (SHELL)
  # ===========================================================================

  # Main Dashboard Backend (FastAPI)
  backend:
    build: ./backend
    container_name: sugarclass-backend
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app
    environment:
      - DATABASE_URL=sqlite+aiosqlite:///./sugarclass.db
      - SECRET_KEY=${SECRET_KEY:-sugarclass-dev-secret-key-change-in-prod}
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    networks:
      - sugarclass-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # Main Dashboard Frontend (Next.js)
  frontend:
    build: ./frontend
    container_name: sugarclass-frontend
    ports:
      - "3400:3000"
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - /app/.next
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8000/api/v1
      - WATCHPACK_POLLING=true
    depends_on:
      - backend
    command: npm run dev
    networks:
      - sugarclass-network
    healthcheck:
      test: [ "CMD-SHELL", "node -e \"fetch('http://127.0.0.1:3000').then(r => process.exit(r.ok ? 0 : 1))\"" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # AI WRITER MICROSERVICE
  # ===========================================================================

  # AI Writer Database (PostgreSQL)
  aiwriter-db:
    image: postgres:15-alpine
    container_name: aiwriter-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: newscollect
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${AIWRITER_DB_PASSWORD:-NewsCollect2024!Secure}
    volumes:
      - aiwriter_db_data:/var/lib/postgresql/data
      - ./microservices/sugarclass-aiwriter/scripts/init_db.sql:/docker-entrypoint-initdb.d/init_db.sql
    # Internal service - No ports exposed to host for security
    networks:
      - sugarclass-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # AI Writer Backend (Python/FastAPI)
  aiwriter-backend:
    build:
      context: ./microservices/sugarclass-aiwriter
      dockerfile: Dockerfile.backend
    container_name: aiwriter-backend
    restart: unless-stopped
    env_file:
      - ./microservices/sugarclass-aiwriter/.env
    environment:
      DB_TYPE: postgresql
      POSTGRES_HOST: aiwriter-db
      POSTGRES_PORT: 5432
      SUGARCLASS_API_URL: http://backend:8000/api/v1
    ports:
      - "8001:8000"
    volumes:
      - ./microservices/sugarclass-aiwriter/backend:/app/backend
      - ./microservices/sugarclass-aiwriter/collector:/app/collector
    depends_on:
      aiwriter-db:
        condition: service_healthy
    networks:
      - sugarclass-network
    command: >
      sh -c "
        sleep 5 &&
        python -c 'from backend.database import init_db; init_db()' &&
        python -m uvicorn backend.api:app --host 0.0.0.0 --port 8000 --reload
      "
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://127.0.0.1:8000/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # AI Writer Frontend (Next.js)
  aiwriter-frontend:
    build:
      context: ./microservices/sugarclass-aiwriter/frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: http://localhost:8001
        NEXT_PUBLIC_BASE_PATH: /aiwriter
    container_name: aiwriter-frontend
    ports:
      - "3401:3000"
    depends_on:
      - aiwriter-backend
    networks:
      - sugarclass-network
    healthcheck:
      test: [ "CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:3000/aiwriter/ || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # AI EXAMINER MICROSERVICE
  # ===========================================================================

  # AI Examiner Backend (Python/FastAPI)
  aiexaminer-backend:
    build:
      context: ./microservices/sugarclass-aiexaminer
      dockerfile: Dockerfile.backend
    container_name: aiexaminer-backend
    restart: unless-stopped
    env_file:
      - ./microservices/sugarclass-aiexaminer/.env
    environment:
      - DB_TYPE=sqlite
      - SQLITE_DB_PATH=./database/examiner.db
      - SUGARCLASS_API_URL=http://backend:8000/api/v1
      - MOBILE_BASE_URL=http://localhost:3403/examiner
    ports:
      - "8003:8000"
    volumes:
      - ./microservices/sugarclass-aiexaminer/.env:/app/.env:ro
      - ./microservices/sugarclass-aiexaminer/backend:/app/backend
      - ./microservices/sugarclass-aiexaminer/database:/app/database
      - ./microservices/sugarclass-aiexaminer/uploads:/app/uploads
    networks:
      - sugarclass-network
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://127.0.0.1:8000/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # AI Examiner Frontend (Next.js)
  aiexaminer-frontend:
    build:
      context: ./microservices/sugarclass-aiexaminer/frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: http://localhost:8003/v1
        NEXT_PUBLIC_BASE_PATH: /examiner
    container_name: aiexaminer-frontend
    ports:
      - "3403:3000"
    depends_on:
      - aiexaminer-backend
    networks:
      - sugarclass-network
    healthcheck:
      test: [ "CMD-SHELL", "node -e \"fetch('http://127.0.0.1:3000/examiner').then(r => process.exit(r.ok ? 0 : 1))\"" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # AI TUTOR MICROSERVICE (Infrastructure Only - Backend WIP)
  # ===========================================================================
  # Note: The AI Tutor has its own docker-compose file for standalone operation.
  # Below are the infrastructure services needed when integrating with the shell.

  # AI Tutor Content Database (PostgreSQL)
  tutor-content-db:
    image: postgres:15-alpine
    container_name: tutor-content-db
    environment:
      POSTGRES_USER: ${TUTOR_CONTENT_DB_USER:-tutor}
      POSTGRES_PASSWORD: ${TUTOR_CONTENT_DB_PASSWORD:-tutor_content_pass}
      POSTGRES_DB: ${TUTOR_CONTENT_DB_NAME:-tutor_content}
    volumes:
      - tutor_content_db_data:/var/lib/postgresql/data
      - ./microservices/sugarclass-aitutor/services/rag_service/database/migrations/001_content_schema.sql:/docker-entrypoint-initdb.d/001_content_schema.sql:ro
      - ./microservices/sugarclass-aitutor/services/rag_service/database/migrations/003_sync_tracking.sql:/docker-entrypoint-initdb.d/003_sync_tracking.sql:ro
    # Internal service - No ports exposed to host
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${TUTOR_CONTENT_DB_USER:-tutor} -d ${TUTOR_CONTENT_DB_NAME:-tutor_content}" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - sugarclass-network

  # AI Tutor Agent Database (PostgreSQL)
  tutor-agent-db:
    image: postgres:15-alpine
    container_name: tutor-agent-db
    environment:
      POSTGRES_USER: ${TUTOR_AGENT_DB_USER:-tutor}
      POSTGRES_PASSWORD: ${TUTOR_AGENT_DB_PASSWORD:-tutor_agent_pass}
      POSTGRES_DB: ${TUTOR_AGENT_DB_NAME:-tutor_agent}
    volumes:
      - tutor_agent_db_data:/var/lib/postgresql/data
      - ./microservices/sugarclass-aitutor/services/rag_service/database/migrations/002_agent_schema.sql:/docker-entrypoint-initdb.d/001_agent_schema.sql:ro
    # Internal service - No ports exposed to host
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${TUTOR_AGENT_DB_USER:-tutor} -d ${TUTOR_AGENT_DB_NAME:-tutor_agent}" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - sugarclass-network

  # Qdrant Vector Store (for AI Tutor semantic search)
  tutor-qdrant:
    image: qdrant/qdrant:latest
    container_name: tutor-qdrant
    # Internal service - No ports exposed to host
    volumes:
      - tutor_qdrant_data:/qdrant/storage
    environment:
      QDRANT__SERVICE__GRPC_PORT: 6334
    healthcheck:
      test: [ "CMD", "bash", "-c", "</dev/tcp/127.0.0.1/6333" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - sugarclass-network

  # Redis (for AI Tutor caching and session management)
  tutor-redis:
    image: redis:7-alpine
    container_name: tutor-redis
    # Internal service - No ports exposed to host
    volumes:
      - tutor_redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - sugarclass-network

  # AI Tutor Backend Service
  tutor-backend:
    build:
      context: ./microservices/sugarclass-aitutor
      dockerfile: Dockerfile.tutor
    container_name: tutor-backend
    env_file:
      - ./microservices/sugarclass-aitutor/.env.prod
    environment:
      CONTENT_DB_URL: postgresql://${TUTOR_CONTENT_DB_USER:-tutor}:${TUTOR_CONTENT_DB_PASSWORD:-tutor_content_pass}@tutor-content-db:5432/${TUTOR_CONTENT_DB_NAME:-tutor_content}
      AGENT_DB_URL: postgresql://${TUTOR_AGENT_DB_USER:-tutor}:${TUTOR_AGENT_DB_PASSWORD:-tutor_agent_pass}@tutor-agent-db:5432/${TUTOR_AGENT_DB_NAME:-tutor_agent}
      QDRANT_URL: http://tutor-qdrant:6333
      QDRANT_COLLECTION: ${QDRANT_COLLECTION:-aitutor_documents}
      REDIS_URL: redis://tutor-redis:6379
      EMBEDDING_MODEL: ${EMBEDDING_MODEL:-BAAI/bge-small-en-v1.5}
      EMBEDDING_DIM: ${EMBEDDING_DIM:-384}
      CONTENT_SOURCE_PATH: /app/content
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    volumes:
      - ./microservices/sugarclass-aitutor/services/rag_service:/app/services/rag_service
      - ./microservices/sugarclass-aitutor/database:/app/content:ro
    ports:
      - "8002:8000"
    depends_on:
      tutor-content-db:
        condition: service_healthy
      tutor-agent-db:
        condition: service_healthy
      tutor-qdrant:
        condition: service_started
      tutor-redis:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://127.0.0.1:8000/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - sugarclass-network

  # AI Tutor Sync Agent (Monitors and syncs content)
  tutor-sync-agent:
    build:
      context: ./microservices/sugarclass-aitutor
      dockerfile: Dockerfile.tutor
    container_name: tutor-sync-agent
    env_file:
      - ./microservices/sugarclass-aitutor/.env.prod
    environment:
      CONTENT_DB_URL: postgresql://${TUTOR_CONTENT_DB_USER:-tutor}:${TUTOR_CONTENT_DB_PASSWORD:-tutor_content_pass}@tutor-content-db:5432/${TUTOR_CONTENT_DB_NAME:-tutor_content}
      QDRANT_URL: http://tutor-qdrant:6333
      QDRANT_COLLECTION: ${QDRANT_COLLECTION:-aitutor_documents}
      REDIS_HOST: tutor-redis
      REDIS_PORT: 6379
      SQLITE_SOURCE_PATH: /app/content/rag_content.db
      SYNC_CHECK_INTERVAL: 21600 # Every 6 hours
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    volumes:
      - ./microservices/sugarclass-aitutor/services/rag_service:/app/services/rag_service
      - ./microservices/sugarclass-aitutor/scripts/migrate_sqlite_to_postgres.py:/app/migrate_sqlite_to_postgres.py:ro
      - ./microservices/sugarclass-aitutor/database:/app/content:ro
    command: python -m services.rag_service.agents.data_sync_agent
    depends_on:
      tutor-content-db:
        condition: service_healthy
      tutor-qdrant:
        condition: service_started
    networks:
      - sugarclass-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "find /tmp/sync_agent_health -mmin -5 | grep . || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # AI Tutor Frontend (React/Vite)
  tutor-frontend:
    build:
      context: ./microservices/sugarclass-aitutor/frontend
      dockerfile: Dockerfile
      args:
        VITE_API_URL: "/aitutor/api"
    container_name: tutor-frontend
    ports:
      - "3402:3000"
    depends_on:
      - tutor-backend
    networks:
      - sugarclass-network
    healthcheck:
      test: [ "CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:3000/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # AI MATERIALS MICROSERVICE
  # ===========================================================================

  # AI Materials Backend (FastAPI)
  aimaterials-backend:
    build:
      context: ./microservices/sugarclass-aimaterials
      dockerfile: Dockerfile
    container_name: aimaterials-backend
    restart: unless-stopped
    env_file:
      - ./microservices/sugarclass-aimaterials/.env
    environment:
      - DB_PATH=/app/database/rag_content.db
      - SUGARCLASS_API_URL=http://backend:8000/api/v1
      - SECRET_KEY=${SECRET_KEY:-sugarclass-dev-secret-key-change-in-prod}
    ports:
      - "8004:8004"
    volumes:
      - ./microservices/sugarclass-aitutor/database:/app/database
      - ./microservices/sugarclass-aimaterials/app:/app/app
      - ./microservices/sugarclass-aimaterials/app/static:/app/app/static:ro
      - ./microservices/sugarclass-aimaterials/archive:/app/archive:ro
      - ./microservices/sugarclass-aimaterials/scripts:/app/scripts:ro
      - ${BOOKS_PATH:-./microservices/sugarclass-aimaterials/archive}:/books:ro
    networks:
      - sugarclass-network
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://127.0.0.1:8004/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # AI Materials Frontend (React/Vite)
  aimaterials-frontend:
    build:
      context: ./microservices/sugarclass-aimaterials/app/frontend
      dockerfile: Dockerfile
      args:
        VITE_API_URL: http://localhost:8004
        VITE_BASE_PATH: /services/aimaterials
    container_name: aimaterials-frontend
    ports:
      - "3404:3000"
    depends_on:
      - aimaterials-backend
    networks:
      - sugarclass-network
    healthcheck:
      test: [ "CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:3000/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  sugarclass-network:
    driver: bridge

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  aiwriter_db_data:
    driver: local
  tutor_content_db_data:
    driver: local
  tutor_agent_db_data:
    driver: local
  tutor_qdrant_data:
    driver: local
  tutor_redis_data:
    driver: local
