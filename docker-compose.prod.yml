# =============================================================================
# Sugarclass - Production Docker Compose
# =============================================================================
# This file extends the base configuration for VPS deployment.
# It includes:
#   1. Nginx Gateway (Port 80/443)
#   2. SSL via Certbot
#   3. Optimized production builds
# =============================================================================

services:
  # ===========================================================================
  # GATEWAY (Reverse Proxy & SSL)
  # ===========================================================================
  gateway:
    build:
      context: ./gateway
    container_name: sugarclass-gateway
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./gateway/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    depends_on:
      frontend:
        condition: service_healthy
      backend:
        condition: service_healthy
      aiwriter-frontend:
        condition: service_healthy
      tutor-frontend:
        condition: service_healthy
      aiexaminer-frontend:
        condition: service_healthy
      aimaterials-frontend:
        condition: service_healthy
    networks:
      - sugarclass-network
    restart: always
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://127.0.0.1:80/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

  certbot:
    image: certbot/certbot
    container_name: sugarclass-certbot
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    networks:
      - sugarclass-network

  # ===========================================================================
  # MAIN DASHBOARD
  # ===========================================================================
  sugarclass-db:
    image: postgres:15-alpine
    container_name: sugarclass-db
    environment:
      POSTGRES_DB: sugarclass
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${SUGARCLASS_DB_PASSWORD:-sugarclass_secure_pass}
    volumes:
      - sugarclass_db_data:/var/lib/postgresql/data
    networks:
      - sugarclass-network
    restart: always
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    build: ./backend
    container_name: sugarclass-backend
    # No exposed ports, accessed via gateway
    environment:
      - DATABASE_URL=postgresql+asyncpg://postgres:${SUGARCLASS_DB_PASSWORD:-sugarclass_secure_pass}@sugarclass-db:5432/sugarclass
      - SECRET_KEY=${SECRET_KEY:-sugarclass-prod-secret-key}
    depends_on:
      sugarclass-db:
        condition: service_healthy
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000
    networks:
      - sugarclass-network
    restart: always
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://127.0.0.1:8000/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

  frontend:
    build:
      context: ./frontend
      args:
        NEXT_PUBLIC_API_URL: /api/v1
    container_name: sugarclass-frontend
    environment:
      - NODE_ENV=production
    command: npm run start
    networks:
      - sugarclass-network
    restart: always
    healthcheck:
      test: [ "CMD-SHELL", "node -e \"fetch('http://127.0.0.1:3000').then(r => process.exit(r.ok ? 0 : 1))\"" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # AI WRITER
  # ===========================================================================
  aiwriter-db:
    image: postgres:15-alpine
    container_name: aiwriter-db
    environment:
      POSTGRES_DB: newscollect
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${AIWRITER_DB_PASSWORD}
    volumes:
      - aiwriter_db_data:/var/lib/postgresql/data
    networks:
      - sugarclass-network
    restart: always
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5

  aiwriter-backend:
    build:
      context: ./microservices/sugarclass-aiwriter
      dockerfile: Dockerfile.backend
    container_name: aiwriter-backend
    env_file:
      - ./microservices/sugarclass-aiwriter/.env
    environment:
      DB_TYPE: postgresql
      POSTGRES_HOST: aiwriter-db
      POSTGRES_PORT: 5432
      SUGARCLASS_API_URL: https://sugarclass.app/api/v1
    depends_on:
      - aiwriter-db
    networks:
      - sugarclass-network
    command: >
      sh -c "
        python -c 'from backend.database import init_db; init_db()' &&
        python -m uvicorn backend.api:app --host 0.0.0.0 --port 8000
      "
    restart: always
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://127.0.0.1:8000/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

  aiwriter-frontend:
    build:
      context: ./microservices/sugarclass-aiwriter/frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: /aiwriter/api
        NEXT_PUBLIC_BASE_PATH: /aiwriter
    container_name: aiwriter-frontend
    networks:
      - sugarclass-network
    restart: always
    healthcheck:
      test: [ "CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:3000/aiwriter/ || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # AI TUTOR
  # ===========================================================================
  tutor-content-db:
    image: postgres:15-alpine
    container_name: tutor-content-db
    environment:
      POSTGRES_USER: ${TUTOR_CONTENT_DB_USER:-tutor}
      POSTGRES_PASSWORD: ${TUTOR_CONTENT_DB_PASSWORD:-tutor_content_pass}
      POSTGRES_DB: ${TUTOR_CONTENT_DB_NAME:-tutor_content}
    volumes:
      - tutor_content_db_data:/var/lib/postgresql/data
      - ./microservices/sugarclass-aitutor/services/rag_service/database/migrations/001_content_schema.sql:/docker-entrypoint-initdb.d/001_content_schema.sql:ro
      - ./microservices/sugarclass-aitutor/services/rag_service/database/migrations/003_sync_tracking.sql:/docker-entrypoint-initdb.d/003_sync_tracking.sql:ro
    networks:
      - sugarclass-network
    restart: always
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U tutor -d tutor_content" ]
      interval: 10s
      timeout: 5s
      retries: 5

  tutor-agent-db:
    image: postgres:15-alpine
    container_name: tutor-agent-db
    environment:
      POSTGRES_USER: ${TUTOR_AGENT_DB_USER:-tutor}
      POSTGRES_PASSWORD: ${TUTOR_AGENT_DB_PASSWORD:-tutor_agent_pass}
      POSTGRES_DB: ${TUTOR_AGENT_DB_NAME:-tutor_agent}
    volumes:
      - tutor_agent_db_data:/var/lib/postgresql/data
      - ./microservices/sugarclass-aitutor/services/rag_service/database/migrations/002_agent_schema.sql:/docker-entrypoint-initdb.d/002_agent_schema.sql:ro
    networks:
      - sugarclass-network
    restart: always
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U tutor -d tutor_agent" ]
      interval: 10s
      timeout: 5s
      retries: 5

  tutor-qdrant:
    image: qdrant/qdrant:latest
    container_name: tutor-qdrant
    volumes:
      - tutor_qdrant_data:/qdrant/storage
    networks:
      - sugarclass-network
    restart: always
    healthcheck:
      test: [ "CMD", "bash", "-c", "</dev/tcp/127.0.0.1/6333" ]
      interval: 10s
      timeout: 5s
      retries: 5

  tutor-redis:
    image: redis:7-alpine
    container_name: tutor-redis
    volumes:
      - tutor_redis_data:/data
    networks:
      - sugarclass-network
    restart: always
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  tutor-backend:
    build:
      context: ./microservices/sugarclass-aitutor
      dockerfile: Dockerfile.tutor
    container_name: tutor-backend
    env_file:
      - ./microservices/sugarclass-aitutor/.env.prod
    environment:
      CONTENT_DB_URL: postgresql://${TUTOR_CONTENT_DB_USER}:${TUTOR_CONTENT_DB_PASSWORD}@tutor-content-db:5432/${TUTOR_CONTENT_DB_NAME}
      AGENT_DB_URL: postgresql://${TUTOR_AGENT_DB_USER}:${TUTOR_AGENT_DB_PASSWORD}@tutor-agent-db:5432/${TUTOR_AGENT_DB_NAME}
      QDRANT_URL: http://tutor-qdrant:6333
      REDIS_URL: redis://tutor-redis:6379
    networks:
      - sugarclass-network
    command: python -m uvicorn services.rag_service.tutor_main:app --host 0.0.0.0 --port 8000
    restart: always
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://127.0.0.1:8000/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # AI Tutor Sync Agent (Monitors and syncs content)
  tutor-sync-agent:
    build:
      context: ./microservices/sugarclass-aitutor
      dockerfile: Dockerfile.tutor
    container_name: tutor-sync-agent
    env_file:
      - ./microservices/sugarclass-aitutor/.env.prod
    environment:
      CONTENT_DB_URL: postgresql://${TUTOR_CONTENT_DB_USER}:${TUTOR_CONTENT_DB_PASSWORD}@tutor-content-db:5432/${TUTOR_CONTENT_DB_NAME}
      QDRANT_URL: http://tutor-qdrant:6333
      QDRANT_COLLECTION: ${QDRANT_COLLECTION:-aitutor_documents}
      REDIS_HOST: tutor-redis
      REDIS_PORT: 6379
      SQLITE_SOURCE_PATH: /app/content/rag_content.db
      SYNC_CHECK_INTERVAL: 21600 # Every 6 hours
    volumes:
      - ./microservices/sugarclass-aitutor/scripts/migrate_sqlite_to_postgres.py:/app/migrate_sqlite_to_postgres.py:ro
      - ./microservices/sugarclass-aitutor/database:/app/content:ro
    command: python -m services.rag_service.agents.data_sync_agent
    depends_on:
      - tutor-content-db
      - tutor-qdrant
    networks:
      - sugarclass-network
    restart: always
    healthcheck:
      test: [ "CMD-SHELL", "find /tmp/sync_agent_health -mmin -5 | grep . || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

  tutor-frontend:
    build:
      context: ./microservices/sugarclass-aitutor/frontend
      dockerfile: Dockerfile
      args:
        VITE_API_URL: /aitutor/api
    container_name: tutor-frontend
    networks:
      - sugarclass-network
    restart: always
    healthcheck:
      test: [ "CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:3000/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # AI EXAMINER
  # ===========================================================================
  aiexaminer-db:
    image: postgres:15-alpine
    container_name: aiexaminer-db
    environment:
      POSTGRES_DB: ${EXAMINER_DB_NAME:-examiner}
      POSTGRES_USER: ${EXAMINER_DB_USER:-postgres}
      POSTGRES_PASSWORD: ${EXAMINER_DB_PASSWORD:-examiner_secure_pass}
    volumes:
      - aiexaminer_db_data:/var/lib/postgresql/data
    networks:
      - sugarclass-network
    restart: always
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5

  aiexaminer-backend:
    build:
      context: ./microservices/sugarclass-aiexaminer
      dockerfile: Dockerfile.backend
    container_name: aiexaminer-backend
    env_file:
      - ./microservices/sugarclass-aiexaminer/.env
    environment:
      - DB_TYPE=postgresql
      - EXAMINER_DB_HOST=aiexaminer-db
      - EXAMINER_DB_PORT=5432
      - EXAMINER_DB_NAME=${EXAMINER_DB_NAME:-examiner}
      - EXAMINER_DB_USER=${EXAMINER_DB_USER:-postgres}
      - EXAMINER_DB_PASSWORD=${EXAMINER_DB_PASSWORD:-examiner_secure_pass}
      - SUGARCLASS_API_URL=https://sugarclass.app/api/v1
      - CORS_ORIGINS=https://sugarclass.app,https://www.sugarclass.app
      - MOBILE_BASE_URL=https://sugarclass.app/examiner
    volumes:
      - examiner_uploads:/app/uploads
    depends_on:
      aiexaminer-db:
        condition: service_healthy
    networks:
      - sugarclass-network
    command: >
      sh -c "
        python backend/init_db.py &&
        python -m uvicorn backend.main:app --host 0.0.0.0 --port 8000
      "
    restart: always
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://127.0.0.1:8000/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

  aiexaminer-frontend:
    build:
      context: ./microservices/sugarclass-aiexaminer/frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: /examiner/api/v1
        NEXT_PUBLIC_BASE_PATH: /examiner
    container_name: aiexaminer-frontend
    depends_on:
      - aiexaminer-backend
    networks:
      - sugarclass-network
    restart: always
    healthcheck:
      test: [ "CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:3000/examiner/ || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # AI MATERIALS
  # ===========================================================================
  aimaterials-backend:
    build:
      context: ./microservices/sugarclass-aimaterials
      dockerfile: Dockerfile
    container_name: aimaterials-backend
    env_file:
      - ./microservices/sugarclass-aimaterials/.env
    environment:
      - DB_PATH=/app/database/rag_content.db
      - SUGARCLASS_API_URL=https://sugarclass.app/api/v1
      - DEBUG=False
      - CORS_ORIGINS=["https://sugarclass.app","https://www.sugarclass.app"]
    volumes:
      - ./microservices/sugarclass-aitutor/database:/app/database:ro
    networks:
      - sugarclass-network
    command: >
      sh -c "
        python -m uvicorn app.main:app --host 0.0.0.0 --port 8004
      "
    restart: always
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://127.0.0.1:8004/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

  aimaterials-frontend:
    build:
      context: ./microservices/sugarclass-aimaterials/app/frontend
      dockerfile: Dockerfile
      args:
        VITE_API_URL: /services/aimaterials/api
        VITE_BASE_PATH: /services/aimaterials
    container_name: aimaterials-frontend
    networks:
      - sugarclass-network
    restart: always
    healthcheck:
      test: [ "CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:3000/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  sugarclass-network:
    driver: bridge

volumes:
  sugarclass_db_data:
  aiwriter_db_data:
  aiexaminer_db_data:
  tutor_content_db_data:
  tutor_agent_db_data:
  tutor_qdrant_data:
  tutor_redis_data:
  examiner_uploads:


